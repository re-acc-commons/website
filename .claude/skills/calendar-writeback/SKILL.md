# Calendar Writeback Skill

Write meeting summaries, notes, and action items back to Google Calendar events.

## Purpose

After processing a meeting transcript, the knowledge extracted shouldn't stay siloed in OPAL. This skill writes the structured output back to the original calendar event, making it discoverable in the context where people manage their time.

## Why This Matters

```
Before writeback:
  - Calendar event: "Team Standup" - just a title and time
  - OPAL: Full transcript, entities, action items
  - Attendees: Have to search OPAL to find notes

After writeback:
  - Calendar event: "Team Standup"
    Description: Summary, key decisions, action items, link to full notes
  - Attendees: See meeting outcomes in their calendar
  - Action items: Optionally created as Google Tasks
```

## When It Runs

This skill is triggered **after review/commit**, not during initial processing:

```
PROCESS â†’ STAGE â†’ REVIEW â†’ COMMIT â†’ [CALENDAR_WRITEBACK]
                                           â†“
                                    Update calendar event
                                    Create tasks (optional)
                                    Link to OPAL notes
```

It can be:
- **Automatic**: Runs after every transcript commit
- **Manual**: Via `/calendar sync` or after `/review --commit`
- **Batched**: Processes all pending writebacks

## Inputs

| Input | Type | Required | Description |
|-------|------|----------|-------------|
| `processed_transcript` | object | Yes | The committed transcript with extracted data |
| `calendar_event_id` | string | Yes | Event ID from meeting-context skill |
| `summary` | string | Yes | Generated meeting summary |
| `action_items` | array | No | Extracted action items with assignees |
| `key_decisions` | array | No | Important decisions made |
| `entities_mentioned` | array | No | Key people/topics for reference |
| `opal_url` | string | No | Link to full notes in OPAL |

## Outputs

```yaml
writeback_result:
  success: true
  event_updated: true
  tasks_created: 3

  event_changes:
    description_updated: true
    previous_description: ""
    new_description: |
      ## Meeting Summary
      Discussed Q1 planning and resource allocation...

      ## Key Decisions
      - Approved new hiring plan
      - Budget increase for project X

      ## Action Items
      - [ ] @alice: Draft proposal by Feb 10
      - [ ] @bob: Schedule follow-up meeting
      - [ ] @carol: Review budget spreadsheet

      ---
      ğŸ“ Full notes: [View in OPAL](https://...)
      ğŸ¤– Auto-generated by OPAL

  tasks:
    - id: "task_123"
      title: "Draft proposal by Feb 10"
      assignee: "alice@example.com"
      due_date: "2026-02-10"
      status: "created"

    - id: "task_124"
      title: "Schedule follow-up meeting"
      assignee: "bob@example.com"
      due_date: null
      status: "created"

  errors: []
```

## Content Generation

The skill generates calendar-appropriate content:

### Meeting Summary

```yaml
summary_generation:
  # Use the already-generated summary from extract/commit
  source: processed_transcript.summary

  # Or generate fresh if needed
  prompt: |
    Summarize this meeting in 2-3 concise paragraphs suitable for
    a calendar event description. Focus on:
    - Main topics discussed
    - Key outcomes
    - Next steps

    Keep it under 500 characters for calendar display.

  # Format for calendar
  format: |
    ## Meeting Summary
    {summary}

    Generated: {timestamp}
```

### Action Items

```yaml
action_items:
  # Extract from processed content
  source: processed_transcript.action_items

  # Format for calendar description
  calendar_format: |
    ## Action Items
    {{#each action_items}}
    - [ ] @{{assignee}}: {{task}}{{#if due}} (due {{due}}){{/if}}
    {{/each}}

  # Create as Google Tasks
  create_tasks:
    enabled: true
    task_list: "OPAL Action Items"  # Create if doesn't exist

    # Map to task structure
    mapping:
      title: "{{task}}"
      notes: "From meeting: {{meeting_title}}\n{{context}}"
      due: "{{due_date}}"
      # Assign via calendar email
      assignee: "{{assignee_email}}"
```

### Key Decisions

```yaml
key_decisions:
  # Extract decisions from transcript
  source: processed_transcript.decisions

  # Or generate from content
  prompt: |
    Extract key decisions made in this meeting.
    Format as bullet points, max 5 items.

  calendar_format: |
    ## Key Decisions
    {{#each decisions}}
    - {{this}}
    {{/each}}
```

### Link to Full Notes

```yaml
opal_link:
  # Generate link to OPAL if hosted
  format: |
    ---
    ğŸ“ Full notes: {{opal_url}}
    ğŸ¤– Auto-generated by OPAL on {{timestamp}}

  # If not hosted, reference local path
  local_fallback: |
    ---
    ğŸ“ Full notes saved to: {{local_path}}
    ğŸ¤– Auto-generated by OPAL
```

## Google Calendar Update

### Description Update Strategy

```yaml
description_strategy:
  # How to handle existing description
  mode: append | prepend | replace | smart_merge

  append:
    # Add OPAL content after existing
    separator: "\n\n---\n\n"
    marker: "<!-- OPAL_START -->"

  prepend:
    # Add OPAL content before existing
    separator: "\n\n---\n\n"

  replace:
    # Replace entire description
    # Only if description is empty or only contains previous OPAL content
    detect_opal: "<!-- OPAL_GENERATED -->"

  smart_merge:
    # Preserve human-written content, update OPAL sections
    opal_sections:
      - "## Meeting Summary"
      - "## Action Items"
      - "## Key Decisions"
    preserve_sections:
      - "## Agenda"
      - "## Pre-meeting Notes"
```

### MCP Tool Calls

```yaml
mcp_tools:
  # Update event description
  - tool: calendar.events.patch
    params:
      calendarId: "{calendar_id}"
      eventId: "{event_id}"
      body:
        description: "{new_description}"

  # Create tasks (if enabled)
  - tool: tasks.tasks.insert
    params:
      tasklist: "{task_list_id}"
      body:
        title: "{task_title}"
        notes: "{task_notes}"
        due: "{due_date_rfc3339}"

  # Get task list (or create if needed)
  - tool: tasks.tasklists.list
  - tool: tasks.tasklists.insert
    params:
      body:
        title: "OPAL Action Items"
```

## Configuration

```yaml
# .opal/sources.yaml or config/integrations.yaml
google_calendar:
  enabled: true
  mcp_server: google-calendar

  # Meeting context (pre-processing)
  meeting_context:
    enabled: true
    time_window_minutes: 30

  # Calendar writeback (post-processing)
  writeback:
    enabled: true

    # What to write
    content:
      summary: true
      action_items: true
      key_decisions: true
      entities_mentioned: false  # Can be noisy
      opal_link: true

    # How to write
    description_mode: smart_merge

    # Task creation
    create_tasks:
      enabled: true
      task_list: "OPAL Meeting Action Items"
      include_assignee: true
      include_due_date: true

    # Timing
    trigger: on_commit  # on_commit | manual | scheduled
    delay_minutes: 0    # Wait before writing (for batch)

    # Safety
    require_confirmation: false  # Prompt before writing
    dry_run_first: false        # Show preview before write
```

## Attendee Notifications

Optionally notify attendees of action items:

```yaml
notifications:
  enabled: false  # Disabled by default - can be noisy

  # Only notify for assigned action items
  action_items_only: true

  # Method
  method: email | calendar_notification

  # Template
  template: |
    Meeting notes from "{{meeting_title}}" are now available.

    Your action items:
    {{#each my_action_items}}
    - {{task}}{{#if due}} (due {{due}}){{/if}}
    {{/each}}

    Full notes: {{opal_url}}
```

## Error Handling

| Scenario | Action |
|----------|--------|
| Event not found | Log error, skip writeback |
| No edit permission | Log warning, skip but don't fail |
| Description too long | Truncate summary, link to full notes |
| Task creation fails | Log error, continue with description update |
| Network error | Queue for retry |
| Rate limited | Backoff and retry |
| Auth expired | Prompt for re-auth |

## Rollback Support

Keep track of changes for potential rollback:

```yaml
rollback:
  # Store original state
  store_original: true
  storage: "_index/calendar-writeback-log.json"

  # Log entry
  log_entry:
    event_id: "abc123"
    timestamp: "2026-02-02T10:30:00Z"
    original_description: "..."
    new_description: "..."
    tasks_created: ["task_123", "task_124"]

  # Rollback command
  command: "/calendar rollback {event_id}"
```

## Manual Commands

```bash
# Sync all pending writebacks
/calendar sync

# Write back specific transcript
/calendar writeback transcripts/standup-2026-02-02.md

# Preview what would be written
/calendar writeback --dry-run transcripts/standup-2026-02-02.md

# Rollback a writeback
/calendar rollback abc123xyz

# Check writeback status
/calendar status
```

## Status Output

```
/calendar status

ğŸ“… Calendar Integration Status
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Connection: âœ… Connected (Google Calendar MCP)

Meeting Context:
â”œâ”€â”€ Enabled: Yes
â”œâ”€â”€ Transcripts enriched: 23
â””â”€â”€ Last enrichment: 2 hours ago

Writeback:
â”œâ”€â”€ Enabled: Yes
â”œâ”€â”€ Events updated: 18
â”œâ”€â”€ Tasks created: 47
â”œâ”€â”€ Pending writebacks: 2
â””â”€â”€ Last writeback: 30 minutes ago

Pending Writebacks:
â”œâ”€â”€ transcripts/planning-2026-02-01.md
â”‚   â””â”€â”€ Event: "Q1 Planning" - Ready to write
â””â”€â”€ transcripts/standup-2026-02-02.md
    â””â”€â”€ Event: "Team Standup" - Ready to write

Run /calendar sync to process pending writebacks.
```

## Integration with Review Flow

When using `/review`, the writeback is mentioned:

```
/review

ğŸ“ Review Session
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

[1/3] transcripts/standup-2026-02-02.md
      â”œâ”€â”€ Source: Meetily transcript
      â”œâ”€â”€ Calendar event: "Team Standup" (Feb 2, 9:00 AM)
      â”œâ”€â”€ Attendees: Alice Smith, Bob Jones, Carol White
      â”œâ”€â”€ Entities extracted: 8
      â”œâ”€â”€ Action items: 3
      â””â”€â”€ ğŸ“… Will update calendar after commit

      [Preview Calendar Update]
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      â”‚ ## Meeting Summary
      â”‚ Discussed sprint progress and blockers...
      â”‚
      â”‚ ## Action Items
      â”‚ - [ ] @alice: Draft proposal by Feb 10
      â”‚ - [ ] @bob: Schedule follow-up meeting
      â”‚ - [ ] @carol: Review budget spreadsheet
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      Actions: [a]ccept [r]eject [e]dit [s]kip [p]review calendar
```

## Privacy Considerations

```yaml
privacy:
  # Don't write sensitive content to shared calendars
  sensitive_content:
    detect: true
    markers: ["confidential", "private", "off the record"]
    action: skip_writeback | warn | redact

  # Calendar visibility
  respect_visibility:
    private_events: skip
    public_events: full_content
    default_events: summary_only

  # Attendee consent
  external_attendees:
    # Don't write to events with external attendees by default
    action: skip | warn | proceed
```

## Workflow Integration

The skill integrates with the broader OPAL workflow:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Meeting happens â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Transcript      â”‚ (Meetily, Otter, etc.)
â”‚ arrives         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ /process        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ MEETING_CONTEXT â”‚ â† Query calendar for attendees
â”‚ CLEANUP         â”‚ â† Use attendee names
â”‚ EXTRACT         â”‚ â† Better entity matching
â”‚ RECONCILE       â”‚
â”‚ STAGE           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ /review         â”‚ Human approves
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ COMMIT          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ WRITEBACK       â”‚ â†’ Update calendar event
â”‚                 â”‚ â†’ Create tasks
â”‚                 â”‚ â†’ Link to notes
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
